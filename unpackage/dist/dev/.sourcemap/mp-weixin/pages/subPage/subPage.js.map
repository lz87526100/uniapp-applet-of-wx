{"version":3,"file":"subPage.js","sources":["pages/subPage/subPage.vue","E:/movie/HBuilderX.4.57.2025032507/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvc3ViUGFnZS9zdWJQYWdlLnZ1ZQ"],"sourcesContent":["<template>\n  <view class=\"layout\">\n    <!-- 新闻标题 & 正文 -->\n<!--    <view class=\"news-panel\">\n      <input class=\"news-title\" v-model=\"form.name\"  placeholder=\"请输入新闻标题（最多 50 字）\" maxlength=\"50\" />\n      <textarea class=\"news-content\" v-model=\"form.description\" placeholder=\"请输入新闻正文（最多 2000 字）\" maxlength=\"2000\" />\n    </view> -->\r\n    \r\n    <uni-forms ref=\"formRef\" :modelValue=\"form\" :rules=\"rules\">\r\n          <!-- 新闻标题 & 正文 -->\r\n          <view class=\"news-panel\">\r\n            <uni-forms-item name=\"name\">\r\n              <input class=\"news-title\" v-model=\"form.name\" placeholder=\"请输入新闻标题（最多 50 字）\" maxlength=\"50\" />\r\n            </uni-forms-item>\r\n            <uni-forms-item name=\"description\">\r\n              <textarea class=\"news-content\" v-model=\"form.description\" placeholder=\"请输入新闻正文（最多 2000 字）\" maxlength=\"2000\" />\r\n            </uni-forms-item>\r\n            </view>\n            </uni-forms>\r\n            \n    <!-- 照片提交卡片 -->\n    <view class=\"pic-card\">\n      <!-- 空态：大卡片 + 图标 + 文字 -->\n      <view v-if=\"pictures.length == 0\" class=\"pic-empty\" @click=\"selectPic\">\n        <text class=\"pic-empty__txt\">点击添加图片</text>\n      </view>\n\n      <!-- 图片列表 -->\n      <view v-for=\"(item,index) in pictures\" :key=\"index\" class=\"pic-item\">\n        <image class=\"pic-item__img\" :src=\"item.temp\" mode=\"aspectFill\" />\n        <!-- 上传中遮罩 -->\n        <view v-if=\"item.status == 1\" class=\"pic-item__mask\">\n          <text class=\"pic-item__progress\">{{item.progress}}%</text>\n        </view>\n        <!-- 关闭按钮 -->\n        <text class=\"pic-item__close\" @click=\"hanldClose\">x</text>\n      </view>\n    </view>\n\n    <!-- 上传按钮 -->\n    <button @click=\"onSubmit\">上传</button>\n  </view>\n</template>\n\n<script setup>\nimport {ref} from 'vue';\nimport dayjs from 'dayjs';\r\n\r\n//获取组件\r\nconst formRef=ref(null);\r\n\r\n//表单数据\r\nconst form = ref({\r\n    classname:'',\r\n    description:'',\r\n    picurl:''\r\n})\r\n\r\n//检验规则\r\nconst rules = {\n  classname: { rules: [{ required: true, errorMessage: '请输入标题' }] },\n  description: { rules: [{ required: true, errorMessage: '请输入正文' }] },\n}\r\n\r\n\n\n//通过pictures中各数据的值来判断状态\n// {temp:\"\",fileID:\"\",url:\"\",status:2,progress:0  }\n// status 0 为显示 + ， 1 为添加进程遮蔽   2 为去掉遮蔽显示图片\nconst pictures = ref([]);\n\n// 关闭 云对象 importObject 交互提示\nconst uploadFileObj = uniCloud.importObject(\"uploadFileObj\",{\n    customUI:true\n});\n\n//照片选择功能模块\nconst  selectPic = async()=>{\n    // 控制图片可选中数量\n   let file = await uni.chooseImage({\n        count:1\n    })\n    //保存 图片的本地文件路径列表 地址\n    pictures.value = file.tempFilePaths.map(item=>({temp:item,status:0,progress:0}));\n\n}\n\n//确认上传\nconst onSubmit = async()=>{\n    \r\n    await formRef.value.validate();\r\n    \r\n    uni.showLoading({mask:true})\r\n    try{\r\n        await uniCloud.database().collection('demo-wallper').add(form.value)\r\n        uni.showToast({\r\n            title:'发布成功',\r\n            icon:'none'\r\n        })\r\n        setTimeout(()=>uni.navigateBack(),500)\r\n    }catch(e){\r\n        uni.showModal({\r\n            content:e.message || '提交失败',\r\n            showCancel:false\r\n        })\r\n    }finally{\r\n        uni.hideLoading()\r\n    }\r\n    \r\n    \r\n    \r\n    \r\n\n    // console.log(pictures.value[0].temp);\n    // 云端路径防重\n    let filename = dayjs().format(\"YYYYMMDD\")+\"/\"+Date.now()+\".jpg\";\n    \n    //更改照片遮盖层加载进度\n    pictures.value[0].status = 1;\n    \n    // cloud文件上传\n    let cloud = await uniCloud.uploadFile({\n        filePath:pictures.value[0].temp,\n         cloudPath:filename,\n         //返回当前进度和总大小\n         onUploadProgress:event=>{\n             // console.log(event);\n             pictures.value[0].progress = Math.round(\n             (event.loaded * 100) / event.total\n             ); \n         }\n    })\n    \n    //重置状态 显示图片\n    pictures.value[0].status = 2;\n    console.log(cloud.fileID);\n     \n    let path =  cloudToHttps(cloud.fileID);\n    \n    pictures.value[0].fileID = cloud.fileID;\n    pictures.value[0].url = path;\n    \n    console.log(pictures.value);\n}\n\n    \n    //对临时地址进行替换\n    const cloudToHttps = (str) =>{\n        return str.replace(\"cloud://\",\"https://\")\n        .replace(str.split(\"/\")[2],str.split(\"/\")[2]+\".normal.cloudstatic.cn\");\n    }\n    \n    //清空删除\n    const hanldClose =()=>{\n        uploadFileObj.remove([pictures.value[0].fileID]).then(res=>{\n            console.log(res);\n        })\n        pictures.value = [];\n    }\n\n</script>\n\n<style lang=\"scss\" scoped>\n/* -------- 新闻提交区（新增） -------- */\n.news-panel{\n  margin: 30rpx;\n  padding: 30rpx;\n  background: #fff;\n  border-radius: 24rpx;\n  box-shadow: 0 4rpx 20rpx rgba(0,0,0,.05);\n  .news-title{\n    width: 93%;\n    height: 80rpx;\n    padding: 0 20rpx;\n    font-size: 28rpx;\n    border: 1rpx solid #e0e0e0;\n    border-radius: 8rpx;\n    margin-bottom: 20rpx;\n  }\n  .news-content{\n    width: 93%;\n    height: 300rpx;\n    padding: 20rpx;\n    font-size: 28rpx;\n    border: 1rpx solid #e0e0e0;\n    border-radius: 8rpx;\n    margin-bottom: 30rpx;\n  }\n}\n\n/* -------- 全新照片卡片（原 .picGroup 已删除） -------- */\n.pic-card{\n  display: flex;\n  flex-wrap: wrap;\n  gap: 24rpx;\n  padding: 30rpx;\n  background: #f5f7fa;\n  border-radius: 24rpx;\n  box-shadow: inset 0 2rpx 4rpx rgba(0,0,0,.05);\n}\n\n/* 空态 */\n.pic-empty{\n  width: 100%;\n  height: 280rpx;\n  border: 2rpx dashed #c8c9cc;\n  border-radius: 16rpx;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  color: #909399;\n  transition: all .3s;\n  &:active{\n    transform: scale(.98);\n    opacity: .8;\n  }\n  &__icon{\n    font-family: \"iconfont\";\n    font-size: 64rpx;\n    margin-bottom: 12rpx;\n  }\n  &__txt{\n    font-size: 28rpx;\n  }\n}\n\n/* 图片项 */\n.pic-item{\n  position: relative;\n  width: calc((100% - 48rpx) / 3);\n  aspect-ratio: 1;\n  border-radius: 16rpx;\n  overflow: hidden;\n  box-shadow: 0 4rpx 12rpx rgba(0,0,0,.15);\n  &__img{\n    width: 100%;\n    height: 100%;\n    display: block;\n  }\n  &__mask{\n    position: absolute;\n    inset: 0;\n    background: rgba(0,0,0,.55);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: #fff;\n    font-size: 32rpx;\n  }\n  &__close{\n    position: absolute;\n    top: 12rpx;\n    right: 12rpx;\n    width: 44rpx;\n    height: 44rpx;\n    border-radius: 50%;\n    background: rgba(0,0,0,.5);\n    color: #fff;\n    font-family: \"iconfont\";\n    font-size: 24rpx;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: transform .2s;\n    &:active{\n      transform: scale(1.15);\n    }\n  }\n}\n\n/* -------- 上传按钮 -------- */\nbutton{\n  margin: 30rpx;\n  width: calc(100% - 60rpx);\n  height: 88rpx;\n  background: #2979ff;\n  color: #fff;\n  font-size: 32rpx;\n  border-radius: 8rpx;\n}\r\n\r\n/* =====================================\n   补充：pic-item 子元素缺失样式\n===================================== */\n\n.pic-item {\n  position: relative;\n  width: calc((100% - 48rpx) / 3);\n  aspect-ratio: 1;\n  border-radius: 16rpx;\n  overflow: hidden;\n  box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.15);\n\n  &_img {\n    width: 100%;\n    height: 100%;\n    display: block;\n  }\n\n  &_mask {\n    position: absolute;\n    inset: 0;\n    background: rgba(0, 0, 0, 0.55);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: #fff;\n    font-size: 32rpx;\n  }\n\n  &_progress {\n    color: #fff;\n    font-size: 32rpx;\n  }\n\n  &_close {\n    position: absolute;\n    top: 12rpx;\n    right: 12rpx;\n    width: 44rpx;\n    height: 44rpx;\n    border-radius: 50%;\n    background: rgba(0, 0, 0, 0.5);\n    color: #fff;\n    font-size: 24rpx;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: transform 0.2s;\n\n    &:active {\n      transform: scale(1.15);\n    }\n  }\n}\n</style>","import MiniProgramPage from 'D:/uni-app/uniCloudDemo0717/pages/subPage/subPage.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","uniCloud","uni","dayjs"],"mappings":";;;;;;;;;;;;;;;AAiDA,UAAM,UAAQA,cAAAA,IAAI,IAAI;AAGtB,UAAM,OAAOA,cAAAA,IAAI;AAAA,MACb,WAAU;AAAA,MACV,aAAY;AAAA,MACZ,QAAO;AAAA,IACX,CAAC;AAGD,UAAM,QAAQ;AAAA,MACZ,WAAW,EAAE,OAAO,CAAC,EAAE,UAAU,MAAM,cAAc,QAAO,CAAE,EAAG;AAAA,MACjE,aAAa,EAAE,OAAO,CAAC,EAAE,UAAU,MAAM,cAAc,QAAO,CAAE,EAAG;AAAA,IACrE;AAOA,UAAM,WAAWA,cAAAA,IAAI,CAAA,CAAE;AAGvB,UAAM,gBAAgBC,cAAAA,GAAS,aAAa,iBAAgB;AAAA,MACxD,UAAS;AAAA,IACb,CAAC;AAGD,UAAO,YAAY,YAAS;AAEzB,UAAI,OAAO,MAAMC,cAAG,MAAC,YAAY;AAAA,QAC5B,OAAM;AAAA,MACd,CAAK;AAED,eAAS,QAAQ,KAAK,cAAc,IAAI,WAAO,EAAC,MAAK,MAAK,QAAO,GAAE,UAAS,EAAC,EAAE;AAAA,IAEnF;AAGA,UAAM,WAAW,YAAS;AAEtB,YAAM,QAAQ,MAAM;AAEpBA,oBAAAA,MAAI,YAAY,EAAC,MAAK,KAAI,CAAC;AAC3B,UAAG;AACC,cAAMD,cAAQ,GAAC,SAAQ,EAAG,WAAW,cAAc,EAAE,IAAI,KAAK,KAAK;AACnEC,sBAAAA,MAAI,UAAU;AAAA,UACV,OAAM;AAAA,UACN,MAAK;AAAA,QACjB,CAAS;AACD,mBAAW,MAAIA,cAAAA,MAAI,aAAY,GAAG,GAAG;AAAA,MACxC,SAAM,GAAE;AACLA,sBAAAA,MAAI,UAAU;AAAA,UACV,SAAQ,EAAE,WAAW;AAAA,UACrB,YAAW;AAAA,QACvB,CAAS;AAAA,MACT,UAAK;AACGA,sBAAAA,MAAI,YAAa;AAAA,MACpB;AAQD,UAAI,WAAWC,oBAAO,EAAC,OAAO,UAAU,IAAE,MAAI,KAAK,IAAK,IAAC;AAGzD,eAAS,MAAM,CAAC,EAAE,SAAS;AAG3B,UAAI,QAAQ,MAAMF,cAAQ,GAAC,WAAW;AAAA,QAClC,UAAS,SAAS,MAAM,CAAC,EAAE;AAAA,QAC1B,WAAU;AAAA;AAAA,QAEV,kBAAiB,WAAO;AAEpB,mBAAS,MAAM,CAAC,EAAE,WAAW,KAAK;AAAA,YACjC,MAAM,SAAS,MAAO,MAAM;AAAA,UAC1C;AAAA,QACU;AAAA,MACV,CAAK;AAGD,eAAS,MAAM,CAAC,EAAE,SAAS;AAC3BC,oBAAY,MAAA,MAAA,OAAA,oCAAA,MAAM,MAAM;AAExB,UAAI,OAAQ,aAAa,MAAM,MAAM;AAErC,eAAS,MAAM,CAAC,EAAE,SAAS,MAAM;AACjC,eAAS,MAAM,CAAC,EAAE,MAAM;AAExBA,2EAAY,SAAS,KAAK;AAAA,IAC9B;AAII,UAAM,eAAe,CAAC,QAAO;AACzB,aAAO,IAAI,QAAQ,YAAW,UAAU,EACvC,QAAQ,IAAI,MAAM,GAAG,EAAE,CAAC,GAAE,IAAI,MAAM,GAAG,EAAE,CAAC,IAAE,wBAAwB;AAAA,IACxE;AAGD,UAAM,aAAY,MAAI;AAClB,oBAAc,OAAO,CAAC,SAAS,MAAM,CAAC,EAAE,MAAM,CAAC,EAAE,KAAK,SAAK;AACvDA,sBAAAA,MAAY,MAAA,OAAA,oCAAA,GAAG;AAAA,MAC3B,CAAS;AACD,eAAS,QAAQ;IACpB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC7JL,GAAG,WAAW,eAAe;"}