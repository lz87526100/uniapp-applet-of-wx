{"version":3,"file":"detail.js","sources":["pages/blog/detail.vue","E:/movie/HBuilderX.4.57.2025032507/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvYmxvZy9kZXRhaWwudnVl"],"sourcesContent":["<template>\n  <view class=\"detailLayout\">\n    <!-- 头部标签 -->\n    <view class=\"soupDetail\">\n      <self-tab-group />\n      <!-- 文章内容 -->\n      <view class=\"content\" v-if=\"article\">\n        <view class=\"userinfo\">\n          <image\n            class=\"avatar\"\n            :src=\"getUserAvatar(article.user_id[0])\"\n            mode=\"aspectFill\"\n            @error=\"handleAvatarError\"\n          />\n          <text class=\"username\">{{ article.user_id[0]?.nickname || '匿名' }}</text>\n          <text class=\"time\">\n            <uni-dateformat\n              :date=\"article.publish_date\"\n              format=\"MM-dd hh:mm\"\n              :threshold=\"[60000, 3600000*24*30]\"\n            />\n          </text>\n        </view>\n\n        <text class=\"text\">{{ article.content }}</text>\n\n        <!-- 图片 -->\n        <view v-if=\"article.pics?.length\" class=\"pics\">\n          <image\n            v-for=\"(pic, idx) in article.pics\"\n            :key=\"idx\"\n            class=\"pic\"\n            :src=\"pic.url\"\n            mode=\"aspectFill\"\n            @click.stop=\"preview(article.pics, idx)\"\n          />\n        </view>\n      </view>\n      \n      <!-- 加载状态 -->\n      <view v-else class=\"loading\">加载中...</view>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref, onMounted, onUnmounted } from 'vue'\nimport { onLoad, onShow } from '@dcloudio/uni-app'\n\n/* ---------- 数据 ---------- */\nconst article = ref(null)\nconst loading = ref(false)\n\n// 用户头像缓存\nconst userAvatarCache = ref(new Map())\n\n/* ---------- 生命周期 ---------- */\nonLoad((options) => {\n  if (options.id) {\n    getArticleDetail(options.id)\n  } else {\n    uni.showToast({ title: '缺少文章ID', icon: 'none' })\n    uni.navigateBack()\n  }\n})\n\n/* ---------- 云对象 ---------- */\nconst articlesCloudObj = uniCloud.importObject('articlesCloudObj')\n\n/* ---------- 监听用户信息更新 ---------- */\nconst setupUserInfoListeners = () => {\n  uni.$on('userInfoUpdated', (data) => {\n    console.log('详情页面收到用户信息更新:', data)\n    updateUserAvatarInDetail(data)\n  })\n}\n\n// 更新详情页面的用户头像\nconst updateUserAvatarInDetail = (userData) => {\n  if (!userData.userId || !userData.avatar || !article.value) return\n  \n  console.log('开始更新详情页面用户头像，用户ID:', userData.userId)\n  \n  // 更新缓存\n  userAvatarCache.value.set(userData.userId, userData.avatar)\n  \n  // 检查当前文章的用户是否匹配\n  if (article.value.user_id && \n      article.value.user_id[0] && \n      article.value.user_id[0]._id === userData.userId) {\n    \n    console.log('更新详情页面头像')\n    \n    // 更新头像数据\n    if (!article.value.user_id[0].avatar_file) {\n      article.value.user_id[0].avatar_file = {}\n    }\n    article.value.user_id[0].avatar_file.url = userData.avatar\n    article.value.user_id[0].avatar_url = userData.avatar\n    \n    // 强制触发视图更新\n    article.value = { ...article.value }\n  }\n}\n\n// 获取用户头像（处理云存储URL）\nconst getUserAvatar = (user) => {\n  if (!user || !user._id) return '/static/defAvatar.png'\n  \n  const userId = user._id\n  \n  // 1. 优先检查缓存\n  if (userAvatarCache.value.has(userId)) {\n    return userAvatarCache.value.get(userId)\n  }\n  \n  // 2. 检查用户对象的头像数据\n  let avatarUrl = '/static/defAvatar.png'\n  \n  // 先检查直接的头像URL（已经转换过的）\n  if (user.avatar_url && user.avatar_url.startsWith('http')) {\n    avatarUrl = user.avatar_url\n  }\n  // 检查云存储的头像文件（需要转换）\n  else if (user.avatar_file && user.avatar_file.url) {\n    const fileUrl = user.avatar_file.url\n    \n    // 如果是云存储URL，需要异步转换，这里先返回默认头像，转换后更新\n    if (fileUrl.startsWith('cloud:')) {\n      // 异步转换URL\n      convertCloudFileUrl(fileUrl, userId)\n      return '/static/defAvatar.png'\n    }\n    // 如果是HTTP URL，直接使用\n    else if (fileUrl.startsWith('http')) {\n      avatarUrl = fileUrl\n    }\n  }\n  // 检查旧的avatar字段（兼容性）\n  else if (user.avatar && user.avatar.startsWith('http')) {\n    avatarUrl = user.avatar\n  }\n  \n  // 缓存结果\n  if (avatarUrl !== '/static/defAvatar.png') {\n    userAvatarCache.value.set(userId, avatarUrl)\n  }\n  \n  return avatarUrl\n}\n\n// 异步转换云存储URL\nconst convertCloudFileUrl = async (fileUrl, userId) => {\n  try {\n    console.log('开始转换云存储URL:', fileUrl)\n    const result = await uniCloud.getTempFileURL({\n      fileList: [fileUrl]\n    })\n    \n    if (result.fileList && result.fileList[0] && result.fileList[0].tempFileURL) {\n      const httpUrl = result.fileList[0].tempFileURL\n      console.log('云存储URL转换成功:', httpUrl)\n      \n      // 更新缓存\n      userAvatarCache.value.set(userId, httpUrl)\n      \n      // 更新详情页面的头像\n      if (article.value && \n          article.value.user_id && \n          article.value.user_id[0] && \n          article.value.user_id[0]._id === userId) {\n        \n        if (!article.value.user_id[0].avatar_file) {\n          article.value.user_id[0].avatar_file = {}\n        }\n        article.value.user_id[0].avatar_file.url = httpUrl\n        article.value.user_id[0].avatar_url = httpUrl\n        \n        // 强制更新视图\n        article.value = { ...article.value }\n      }\n    }\n  } catch (error) {\n    console.error('转换云存储URL失败:', error)\n  }\n}\n\n// 头像加载失败处理\nconst handleAvatarError = (event) => {\n  console.log('头像加载失败:', event)\n  // 可以在这里设置默认头像\n}\n\n// 初始化用户头像缓存\nconst initUserAvatarCache = () => {\n  if (!article.value || !article.value.user_id || !article.value.user_id[0]) return\n  \n  const user = article.value.user_id[0]\n  const userId = user._id\n  \n  let avatarUrl = '/static/defAvatar.png'\n  \n  // 按优先级检查头像来源\n  if (user.avatar_url && user.avatar_url.startsWith('http')) {\n    avatarUrl = user.avatar_url\n  } else if (user.avatar_file && user.avatar_file.url) {\n    const fileUrl = user.avatar_file.url\n    if (fileUrl.startsWith('http')) {\n      avatarUrl = fileUrl\n    } else if (fileUrl.startsWith('cloud:')) {\n      // 异步转换云存储URL\n      convertCloudFileUrl(fileUrl, userId)\n    }\n  } else if (user.avatar && user.avatar.startsWith('http')) {\n    avatarUrl = user.avatar\n  }\n  \n  if (avatarUrl !== '/static/defAvatar.png') {\n    userAvatarCache.value.set(userId, avatarUrl)\n    console.log(`缓存用户 ${userId} 头像:`, avatarUrl)\n  }\n}\n\nasync function getArticleDetail(id) {\n  loading.value = true\n  try {\n    const { errCode, data, errMsg } = await articlesCloudObj.getDetail(id)\n    if (errCode === 0) {\n      article.value = data\n      \n      // 初始化头像缓存\n      initUserAvatarCache()\n      \n      // 调试：显示用户信息\n      if (data.user_id && data.user_id[0]) {\n        const user = data.user_id[0]\n        console.log('详情页面用户信息:', {\n          id: user._id,\n          nickname: user.nickname,\n          avatar_url: user.avatar_url,\n          avatar_file: user.avatar_file,\n          avatar: user.avatar\n        })\n      }\n    } else {\n      uni.showToast({ title: errMsg || '获取文章失败', icon: 'none' })\n    }\n  } catch (error) {\n    console.error('获取文章详情失败:', error)\n    uni.showToast({ title: '网络错误', icon: 'none' })\n  } finally {\n    loading.value = false\n  }\n}\n\n/* ---------- 事件 ---------- */\nfunction preview(pics, idx) {\n  uni.previewImage({\n    urls: pics.map(p => p.url),\n    current: idx\n  })\n}\n\n// 页面加载时设置监听\nonMounted(() => {\n  console.log('详情页面加载')\n  setupUserInfoListeners()\n  \n  // 检查是否有待更新的用户信息\n  const pendingUpdate = uni.getStorageSync('userInfoPendingUpdate')\n  if (pendingUpdate) {\n    console.log('详情页面发现待更新的用户信息:', pendingUpdate)\n    updateUserAvatarInDetail(pendingUpdate)\n    uni.removeStorageSync('userInfoPendingUpdate')\n  }\n})\n\n// 页面卸载时移除监听\nonUnmounted(() => {\n  console.log('详情页面卸载')\n  uni.$off('userInfoUpdated')\n})\n\n// 页面显示时重新检查更新\nonShow(() => {\n  console.log('详情页面显示')\n  // 检查是否有新的用户信息更新\n  const lastUpdate = uni.getStorageSync('lastUserInfoUpdate')\n  if (lastUpdate) {\n    console.log('详情页面显示时检查到用户信息更新:', lastUpdate)\n    updateUserAvatarInDetail(lastUpdate)\n  }\n})\n</script>\n\n<style lang=\"scss\" scoped>\n.detailLayout {\n  min-height: 100vh;\n  background: #fff;\n}\n\n.soupDetail {\n  padding: 50rpx 30rpx;\n  border-bottom: 12rpx solid #f7f7f7;\n}\n\n.content {\n  margin-top: 30rpx;\n\n  .userinfo {\n    display: flex;\n    align-items: center;\n    margin-bottom: 24rpx;\n\n    .avatar {\n      width: 72rpx;\n      height: 72rpx;\n      border-radius: 50%;\n      margin-right: 16rpx;\n    }\n\n    .username {\n      font-size: 30rpx;\n      font-weight: 600;\n      color: #4f8bff;\n    }\n\n    .time {\n      margin-left: auto;\n      font-size: 24rpx;\n      color: #8b9ab6;\n    }\n  }\n\n  .text {\n    font-size: 34rpx;\n    line-height: 1.8em;\n    color: #222;\n  }\n\n  .pics {\n    display: grid;\n    grid-template-columns: repeat(3, 1fr);\n    gap: 12rpx;\n    margin-top: 20rpx;\n\n    .pic {\n      width: 100%;\n      height:100%;\n      aspect-ratio: 1;\n      border-radius: 12rpx;\n    }\n  }\n}\n\n.loading {\n  text-align: center;\n  padding: 40rpx;\n  color: #999;\n}\n</style>","import MiniProgramPage from 'D:/uni-app/uniCloudDemo0717/pages/blog/detail.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","onLoad","uni","uniCloud","onMounted","onUnmounted","onShow"],"mappings":"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"}